##参考文档
* 第三方中间件
 * Seata
    * http://blog.itpub.net/69926045/viewspace-2673611/
    * https://mp.weixin.qq.com/s?__biz=MzUzNzYxNjAzMg==&mid=2247498350&idx=1&sn=8fd6a7a0c306c566c790f9851310d7df&chksm=fae6f1a1cd9178b74be60eb4ecb1d0d56801129296a183a9be6bd6990bfebff3c19363d65165&scene=132#wechat_redirect
    * https://www.cnblogs.com/zpKang/p/14197727.html
 * ShardingSphere
## 分布式事务为了解决什么问题
* 分布式环境 是为了解决分布式系统下数据库一致性问题的
* 现在有A，B，C 3个服务，其中A开启本地事务更新数据库，通过rpc接口调用B，C服务更新数据库，
* 对于数据库来讲A，B，C各开启了一个会话，出错只能各自回滚事务
* 对于业务来讲，A，B，C服务要么都成功，要么都失败，此时便出现了分布式事务的问题
## 分布式事务相关概念
* 本地事务：当事务由资源管理器本地管理时被称作本地事务
* 全局事务：一批本地事务组成的整体，统一驱动全局提交或回滚
* 全局事务协调器（简称TC）
* DTP 模型
    * 应用程序(Application Program ，简称AP)：用于定义事务边界(即定义事务的开始和结束)，并且在事务边界内对资源进行操作，可以简单理解为我们的应用程序。
    * 资源管理器(Resource Manager，简称RM)：如数据库、文件系统等，并提供访问资源的方式。
    * 事务管理器(Transaction Manager ，简称TM)：负责分配事务唯一标识，监控事务的执行进度，并负责事务的提交、回滚等。
    * 通信资源管理器(Communication Resource Manager，简称CRM)：控制一个TM域(TM domain)内或者跨TM域的分布式应用之间的通信。
    * 通信协议(Communication Protocol，简称CP)：提供CRM提供的分布式应用节点之间的底层通信服务
    * TX协议：AP与TM的接口
    * XA协议
        * TM与RM的接口。全局事务管理器一般使用XA二阶段协议与数据库进行交互。
        * MySQL 从5.0.3开始支持XA分布式事务，且只有InnoDB存储引擎支持                                             
* BASE理论
    * BA指的是基本业务可用性，支持分区失败，
    * S表示柔性状态，也就是允许短时间内不同步，
    * E表示最终一致性，数据最终是一致的，但是实时是不一致的。
    * 原子性和持久性必须从根本上保障，为了可用性、性能和服务降级的需要，只有降低一致性和隔离性的要求。
* CAP定理
    * 最多只能同时拥有CAP其中的两个
    * C表示一致性，也就是所有用户看到的数据是一样的。
    * A表示可用性，是指总能找到一个可用的数据副本。
    * P表示分区容错性，能够容忍网络中断等故障。
# 分布式事务设计方案
##两阶段提交协议
* 转载：https://www.imooc.com/article/303856/
* XA用于在全局事务中协调多个资源的机制。TM和RM之间采取两阶段提交的方案来解决一致性问题。
* 流程
    * 通过 Start 启动一个 XA 事务，并且被置为 Active 状态，
    * 处在 active 状态的事务可以执行 SQL 语句，
    * 通过 END 方法将 XA 事务置为 IDLE 状态。
    * 处于 IDLE 状态可以执行 PREPARE 操作或者 COMMIT…ONE PHASE 操作，也就是二阶段提交中的第一阶段PREPARED 状态
    * PREPARED 状态的 XA事务的时候就可以 Commit 或者 RollBack，也就是二阶段提交的第二阶段。
##三阶段提交
* 引入超时机制。同时在协调者和参与者中都引入超时机制。
* 在第一阶段和第二阶段中插入一个准备阶段。保证了在最后提交阶段之前各参与节点的状态是一致的。
* 3PC把2PC的准备阶段再次一分为二，这样三阶段提交就有CanCommit、PreCommit、DoCommit三个阶段
##TCC事务模式
* 转载：https://www.cnblogs.com/duanxz/p/5226316.html
* 1.Try：
  - 尝试执行业务。
  - 完成所有业务检查(一致性)
  - 预留必须业务资源(准隔离性)
* 2、Confirm：确认执行业务。 
  - 真正执行业务
  - 不做任何业务检查
  - 只使用Try阶段预留的业务资源
* 3、Cancel：取消执行业务
  - 释放Try阶段预留的业务资源
##消息一致性分布式事务
##AT模式
* 转载：https://www.cnblogs.com/zpKang/p/14197704.html
* AT 模式就是自动补偿式事务
* 第一阶段： 执行各分支事务
    * TC生成全局事务xid，各个事务分支共享
    * 解析sql并查询得到前镜像保存在undo日志，为了回滚事务
    * 执行业务 sql。
    * 查询执行后的数据作为后镜像保存在undo日志  
* 第二阶段： 控制全局事务最终提交或回滚
    * 根据undo日志回滚或删除事务表
  



     

